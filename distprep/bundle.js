(()=>{"use strict";class t{constructor(t=1/30,e,i=!1){this.at=0,this.lt=null,this.dt=t,this.t=e,i&&this.start(),this.p=this.s=!1}fireOnce(){this.queue(),this.s=!0}up(t){this.t.update(Math.floor(t/1e3)),this.lt=t,this.s||this.queue()}up2(t){if(this.lt)for(this.at+=(t-this.lt)/1e3,this.at>1&&(this.at=1);this.at>this.dt;){this.t.update(Math.floor(t/1e3)),this.at-=this.dt;break}this.lt=t,this.s||this.queue()}togglePause(){this.p=!this.p}queue(){requestAnimationFrame((t=>{this.up2(t)}))}start(){this.s=!1,this.queue()}stop(){this.s=!0}}class e{constructor(t){this.main=t,this.Objects=[]}update(t){this.time=t,[...this.Objects].forEach((e=>{e.update&&e.update(t)})),this.Objects=this.Objects.filter((t=>!t.delete))}draw(t){t.clearRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="black",t.fillRect(0,0,t.canvas.width,t.canvas.height),[...this.Objects].forEach((e=>{e.draw&&e.draw(t)}))}ss(t){this.main.previousScene=this.main.scene,t.main=this.main,this.main.toScene(t)}prevss(t){this.main.toScene(this.main.previousScene),this.main.previousScene=t}notify(t){let e=t.name,i=t.event;"keydown"==e&&this.keydown?this.keydown(i):"keyup"==e&&this.keyup?this.keyup(i):"mousemove"==e&&this.mousemove?this.mousemove(i):"click"==e&&this.click?this.click(i):"control"==e&&this.control?this.control(i.key):"controlts"==e&&this.controlts?this.controlts(i.key):"controlte"==e&&this.controlte&&this.controlte(i.key)}mousemove(t){}keyup(t){this.control(t.key)}}const i=Math.PI,s=(t,e=document)=>e.querySelector(t),r=t=>t<0?-t:t,a=(t=1,e=0)=>0|((t=1,e=0)=>e+(t-e)*Math.random())(t,e),h=(t=0,e=0)=>{let i=document.createElement("canvas");return i.width=t,i.height=e,i},n=t=>t.getContext("2d"),o=(t,e,i,s)=>t+e+i+s==0?null:t+e+i==0||t>255||e>255||i>255?"#000000":"#"+((t<<16)+(e<<8)+i).toString(16).padStart(6,"0"),c=(t,e,s=!0)=>((t,e,i=!0)=>{let s,r;var a,o;i&&e%(Math.PI/4)!=0?(a=t.width,o=t.height,s=r=Math.sqrt(a*a+o*o)):(s=t.width,r=t.height);const c=h(s,r),l=n(c),u={x:s/2,y:r/2};return l.imageSmoothingQuality="high",l.save(),l.translate(u.x,u.y),l.rotate(e),l.drawImage(t,0,0,t.width,t.height,-t.width/2,-t.height/2,t.width,t.height),l.restore(),c})(t,(e%=8)*i/4,s),l=(t,e,i,s,r)=>{let a=h(s,r);return n(a).drawImage(t,e,i,s,r,0,0,s,r),a},u=(t,e=1,i=null)=>{let s=t.length,r=Math.max(...t.map((t=>t.length)));var a=h(r*e,s*e),o=n(a);for(let a=0;a<s;a++)for(let s=0;s<r;s++){var c=t[a][s];i&&(c=i(c)),c&&""!=c&&(o.fillStyle=c,o.fillRect(s*e,a*e,e,e))}return a},p=(t,e)=>{for(var i=n(t),s=t.width,r=t.height,a=i.getImageData(0,0,s,r).data,h=[],c=0;c<a.length;c+=4)h.push(o(a[c],a[c+1],a[c+2],a[c+3]));var l=[];for(let e=0;e<t.height;e++)l[e]=[];let u=0,p=0;for(let i=0;i<h.length;i++)u>=t.width&&(p++,u=0),l[p][u]=h[i],e&&(l[p][u]=e(l[p][u])),u++;return l};function d(t,e,i="source-atop"){let s=h(t.width,t.height),r=n(s);return r.drawImage(t,0,0),r.globalCompositeOperation=i,r.fillStyle=e,r.fillRect(0,0,s.width,s.height),s}const g=(t,e,i="source-atop")=>{let s=h(t.width,t.height),r=n(s);r.drawImage(t,0,0),r.globalCompositeOperation=i;for(let i=0;i<t.width/e.width;i++)for(let s=0;s<t.height/e.height;s++)r.drawImage(e,i*e.width,s*e.height);return s},m=0,f=1,w=2,y=3,v=4,x=5,S=6,b=7,T=(t,e=!0)=>{let i=h(t.width,t.height),s=n(i);return s.save(),e?(s.scale(-1,1),s.drawImage(t,0,0,-1*t.width,t.height)):(s.scale(1,-1),s.drawImage(t,0,0,t.width,-1*t.height)),s.restore(),i},M=t=>{var e=h(t[0].width,t[0].height),i=n(e);for(let e in t)i.drawImage(t[e],0,0);return e};function E(t,e){let i=h(t.width+e.width,t.height+e.height),s=n(i);return s.drawImage(t,0,0),s.drawImage(t,t.width,e.height),s.drawImage(e,t.width,0),s.drawImage(e,0,t.height),i}function I(t,e,i=0){0==i&&(i=e);var s=h(t.width*i,t.height*e),r=n(s);for(let s=0;s<e;s++)for(let e=0;e<i;e++)r.drawImage(t,e*t.width,s*t.height);return s}function L(t,e){let i=h(t.width,t.height),s=n(i);return s.globalAlpha=e,s.drawImage(t,0,0),s.globalAlpha=1,i}function A(t,e,i,s=!1){var r=h(e,i),a=n(r);return s&&a.fillRect(0,0,e,i),a.drawImage(t,e/2-t.width/2,i/2-t.height/2),r}function k(t){return t>1e9?parseInt(t/1e6)+"B":t>1e6?parseInt(t/1e6)+"M":t>1e3?parseInt(t/1e3)+"K":t}function P(t,e,i,r){let a=s("#spriteSheetMain");var h=l(a,8*t,8*e,8*i,8*r);return p(h,(t=>"#ffffff"===t?"":t))}function C(t,e){for(var i=0;i<t.length;i++)for(var s=0;s<t[i].length;s++)e(t[s][i],i,s)}class R{constructor(t={}){}static get(t,e,i,s,r="Arial",a=0,o=0){let c=n(h(1,1));c.font=e+"px "+r;const l=a||c.measureText(t).width||1,u=o||e+2;let p=h(parseInt(l),u);c=n(p),c.font=e+"px "+r,c.fillStyle=i,c.fillText(t,0,e-2),s&&(p=g(p,s));var d=h(p.width,p.height),m=n(d);return m.fillStyle="#ffffff",m.drawImage(p,0,0),d}}const O={dirt:P(0,0,1,1),grass:P(1,0,1,1),water:P(2,0,1,1),steel:P(3,0,1,1),brick:P(4,0,1,1),sword:P(0,1,1,1),bow:P(1,1,1,1),arrow:P(2,1,1,1),magic:P(3,1,1,1),tree:P(4,1,1,1),coin:P(0,2,1,1),apple:P(1,2,1,1),lemon:P(2,2,1,1),rabbit:P(0,3,1,1),wolf:P(1,3,2,1),castle:P(9,0,4,4),cave:P(3,2,2,2),player:P(0,4,2,2),playerb:P(2,4,2,2),players:P(4,4,1,2),playerh:P(5,4,1,2),wizzard:P(6,4,1,2),bear:P(7,4,2,2),deer:P(9,4,2,2),house:P(5,0,2,2),shop:P(5,2,2,2),npcman:P(7,0,2,2),npcgirl:P(7,2,2,2),snow:P(11,4,1,1),map_spawn:P(0,6,2,2),map_castle:P(2,6,2,2),map_forest_1:P(4,6,2,2),map_forest_2:P(6,6,2,2),map_forest_3:P(8,6,2,2),map_forest_4:P(10,6,2,2)},_={dirt:u(O.dirt,1),grass:u(O.grass,1),water:u(O.water,1),steel:u(O.steel,1),brick:u(O.brick,1),sword:u(O.sword,1),bow:u(O.bow,1),arrow:u(O.arrow,1),magic:u(O.magic,1),tree:u(O.tree,1),coin:u(O.coin,1),apple:u(O.apple,1),lemon:u(O.lemon,1),rabbit:u(O.rabbit,1),wolf:u(O.wolf,1),castle:u(O.castle,1),cave:u(O.cave,1),player:u(O.player,1),playerb:u(O.playerb,1),players:u(O.players,1),playerh:u(O.playerh,1),wizzard:u(O.wizzard,1),bear:u(O.bear,1),deer:u(O.deer,1),house:u(O.house,1),shop:u(O.shop,1),npcman:u(O.npcman,1),npcgirl:u(O.npcgirl,1),snow:u(O.snow,1),map_spawn:u(O.map_spawn,1),map_castle:u(O.map_castle,1),map_forest_1:u(O.map_forest_1,1),map_forest_2:u(O.map_forest_2,1),map_forest_3:u(O.map_forest_3,1),map_forest_4:u(O.map_forest_4,1)};u(O.castle,2),u(O.house,2),u(O.shop,2),u(O.cave,2);class H{constructor(t,e){this.x=t,this.y=e}is(t){let e=this.x,i=this.y,s=t.x,r=t.y;return e==s&&i==r}distanceTo(t){if(!t)return 1/0;let e=this.x,i=this.y,s=t.x,r=t.y;if(e==s&&i==r)return 0;if(e==s)return Math.abs(i-r);if(i==r)return Math.abs(e-s);{let t=0;return t+=Math.pow(e-s,2),t+=Math.pow(i-r,2),t=Math.sqrt(t),t}}getAngleTo(t){let e=this.x,i=this.y,s=t.x,r=t.y;return e==s&&i==r?0:e==s&&i>r||i==r&&e<s||e==s&&i<r||i==r&&e>s||e<s&&i>r||e<s&&i<r||e>s&&i<r||e>s&&i>r?0*Math.PI/4:0}getDirectionTo(t){let e=this.x,i=this.y,s=t.x,r=t.y;return e==s&&i==r?v:e>s?S:e<s?w:i<r?v:i>r?m:v}moveClone(t,e){let i=this.clone();return i.move(t,e),i}move(t,e){t==m?this.y-=e:t==v?this.y+=e:t==S?this.x-=e:t==w?this.x+=e:t==b?(this.y-=e,this.x-=e):t==f?(this.y-=e,this.x+=e):t==y?(this.y+=e,this.x+=e):t==x&&(this.y+=e,this.x-=e)}moveAngleClone(t,e){t-=Math.PI/2;const i=e*Math.cos(t),s=e*Math.sin(t);return new H(this.x+i,this.y+s)}moveClone(t,e){let i=this.clone();return i.move(t,e),i}movetoward(t,e){let i=t.x-this.x,s=t.y-this.y,r=Math.sqrt(i*i+s*s),a=i/r||0,h=s/r||0;r<e?(this.x=t.x,this.y=t.y):(this.x+=a*e,this.y+=h*e)}movetowardGrid(t,e){t.x>this.x?this.x+=e:t.x<this.x?this.x-=e:t.y<this.y?this.y-=e:t.y>this.y&&(this.y+=e)}clone(){return new H(this.x,this.y)}draw(t,e="red"){t.fillStyle=e,this.drawCircle(t,3,e)}drawCircle(t,e=4,i="green"){t.fillStyle=i,t.strokeStyle=i,t.beginPath(),t.arc(this.x,this.y,e,0,2*Math.PI),t.fill()}static drawCircle(t,e,i,s=1,r="green"){t.fillStyle=r,t.strokeStyle=r,t.beginPath(),t.arc(e,i,s,0,2*Math.PI),t.fill()}}const D=[{mcd:25,attack:1,life:1,name:"rabbit"},{mcd:25,attack:4,life:5,name:"wolf"},{mcd:25,attack:10,life:8,name:"deer"},{mcd:25,attack:20,life:10,name:"bear"},{mcd:25,attack:15,life:10,name:"npcman"},{mcd:25,attack:10,life:10,name:"npcgirl"}];class z{constructor(t,e=0,i=null){this.type=e,this.scene=t,this.sprites=this.getSprites(),this.sprite=this.sprites[this.type],this.center=i||t.findAValidSpawnPoint(8,25),this.life=D[this.type].life,this.maxLife=D[this.type].life,this.moveCountDown=D[this.type].mcd,this.pathToGo=[]}activate(){this.active=!0}moveTowardPlayer(){var t=this.scene.tileSize;const e=this.scene.pathFinder.findPath(this.center.x/t,this.center.y/t,this.scene.player.center.x/t,this.scene.player.center.y/t);e&&e.length>=2&&(this.center=new H(e[1][0]*t,e[1][1]*t))}getPossibleNextMove(){var t=this.scene.tileSize;if(this.pathToGo.length>0){var e=this.pathToGo.shift();this.center=new H(e[0]*t,e[1]*t)}else{const e=this.scene.pathFinder.findPath(this.center.x/t,this.center.y/t,this.scene.player.center.x/t,this.scene.player.center.y/t);e&&e.length>=0&&(this.pathToGo=e)}}update(t){this.time=t,this.moveCountDown--,this.moveCountDown<=0&&(this.moveCountDown=D[this.type].mcd-this.scene.difficulity,this.moveTowardPlayer(),this.center.distanceTo(this.scene.player.center)<1.5*this.scene.tileSize&&(this.scene.player.life-=this.type+1,this.scene.player.showDamageEffect=3))}getHealthBar(){var t=h(this.sprite.width,3),e=n(t);e.fillStyle="green";var i=this.sprite.width*(this.life/this.maxLife);return e.fillRect(0,0,i,3),t}draw(t){t.drawImage(this.sprite,this.center.x,this.center.y),this.life<this.maxLife&&t.drawImage(this.getHealthBar(),this.center.x,this.center.y)}getSprites(){if(z.SPRITES)return z.SPRITES;var t=this.scene.scalemultiplier,e=this.scene.tileSize,i=A(u(O.rabbit,t),e,e,!1),s=A(u(O.wolf,t),e,e,!1),r=A(u(O.deer,t),e,e,!1),a=u(O.bear,t),h=u(O.npcman,t),n=u(O.npcgirl,t),o=u(O.sword,t);this.w=e,this.h=e;var c=[i,s,r,a,h,n,o];return z.SPRITES=c,z.SPRITES}}class N extends z{constructor(t,e=0,i=null){super(t,e,i)}draw(t){super.draw(t),t.drawImage(this.sprites[6],this.center.x+.65*this.sprite.width,this.center.y+.25*this.sprite.height)}}class G{constructor(t,e=2){this.scene=t,this.mult=e,this.mobs=[],this.getSprites(e)}setHeadPoint(t){var e=this.scene.tileSize*this.mult,i=this.scene.tileSize*this.mult;this.center=new H(t.x+e/2,t.y+i/2);var s=new H(t.x,t.y+i),r=new H(t.x+this.scene.tileSize,t.y+i),a=new H(t.x+2*this.scene.tileSize,t.y+i);this.spawnLocations=[s,r,a]}draw(t){t.drawImage(this.brick,this.center.x-this.brick.width/2,this.center.y-this.brick.width/2)}update(t){this.time=t,this.mobs=this.mobs.filter((t=>t.life>0));var e=Math.abs(this.center.y-this.scene.player.center.y),i=Math.abs(this.center.x-this.scene.player.center.x);if(e<=8*this.scene.tileSize&&i<=6*this.scene.tileSize)for(let t in this.spawnLocations)if(!(s=this.scene.haveEntityAt(this.spawnLocations[t].x,this.spawnLocations[t].y))){var s=new N(this.scene,4,this.spawnLocations[t]);this.mobs.push(s),this.scene.mobs.push(s)}[...this.mobs].forEach((e=>{e.update&&e.update(t)}))}getSprites(t=2){var e=u(O.castle,t),i=((t,e)=>{var i=p(t);const s=i.flat(),r=[...new Set(s)],a={};for(const t of r){a[t]=[];for(let e=0;e<i.length;e++){a[t].push([]);for(let s=0;s<i[e].length;s++)i[e][s]===t?a[t][e][s]="#000000":a[t][e][s]=null}}return delete a.null,a})(e),s=u(i["#6a6a6a"]),r=u(i["#c2c2c2"]),a=g(s,L(_.dirt,.5)),h=g(s,L(_.grass,.5)),n=g(s,L(_.water,.5)),o=g(s,L(_.brick,.5)),c=g(s,L(_.steel,.5)),l=g(s,L(_.magic,.5)),d=g(r,L(_.dirt,.2)),m=g(r,L(_.grass,.2)),f=g(r,L(_.water,.2)),w=g(r,L(_.brick,.2)),y=g(r,L(_.steel,.2)),v=g(r,L(_.magic,.2));this.dirt=M([e,d,a]),this.grass=M([e,m,h]),this.water=M([e,f,n]),this.brick=M([e,w,o]),this.steel=M([e,y,c]),this.magic=M([e,v,l])}}class B extends e{constructor(t){super(t);var e=_.dirt,i=_.steel,s=E(e,_.grass),r=E(i,e);this.castleObj=new G(this),this.player=u(O.player,2),this.gmat=function(t,e,i,s,r=1){r>1&&(t=I(t,r),e=I(e,r));let a=E(t,e);var o=h(a.width*s,a.height*i),c=n(o);for(let t=0;t<i;t++)for(let e=0;e<s;e++)c.drawImage(a,t*a.height,e*a.width);return o}(s,r,this.main.canvas.width/8,this.main.canvas.height/8),this.gmat=L(this.gmat,.2),this.log=this.getLogo(),this.buffer=this.getBuffer(),this.loading=-20,this.intro=this.getIntro()}getLogo(){var t=h(400,200),e=n(t),i=_.grass,s=_.dirt,r=_.water,a=_.steel,o=E(s,i),c=E(a,a),l=E(i,r),u=E(r,s),p="Arial Black";return this.TextSprites=[R.get("13th CENTURY™",20,"green",u,p),R.get("ROBIN➸HOOD ",40,"green",o,p),R.get("THE➸OUTLAW ",28,"green",c,p),R.get("★1370s∵∴∵∴∵∴∵∴∵∴∵∴∵2023★",15,"green",l,p)],e.drawImage(d(this.TextSprites[0],"white"),0,1),e.drawImage(this.TextSprites[0],1,1),e.drawImage(d(this.TextSprites[1],"red"),1,18),e.drawImage(this.TextSprites[1],0,17),e.drawImage(d(this.TextSprites[2],"white"),85,53),e.drawImage(this.TextSprites[2],85,52),e.drawImage(this.TextSprites[3],82,82),t}getIntro(){var t=["you step into the legendary shoes of Robin Hood.","your mission is to make the world a better place.","- explore forest and hunt animals","- trade with merchants","- take quest from villagers","- improve your stats and defend the village","a w s d / arrows for movement","e interact, q menue, space fire"],e=h(360,500);let i=n(e);i.fillStyle="white",i.font="16px Arial";for(let e=0;e<t.length;e++)i.fillText(t[e],0,25*e+20);return e}async prepareCanvas(){}update(t){this.time=t,this.loading+=.8}getBuffer(){let t=h(this.main.config.width,this.main.config.height),e=n(t);e.drawImage(this.gmat,0,0);var i=this.main.config.width<400?16:128;return e.drawImage(this.log,i,74),t}draw(t){t.clearRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="black",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(this.buffer,0,0),t.drawImage(this.castleObj.dirt,16,192),t.drawImage(this.castleObj.grass,88,192),t.drawImage(this.castleObj.water,160,192),t.drawImage(this.castleObj.brick,232,192),t.drawImage(this.castleObj.steel,304,192),t.drawImage(this.castleObj.magic,376,192),t.drawImage(this.player,16,320),t.drawImage(l(this.intro,0,this.loading%this.intro.height,this.intro.width,200),64,320)}goToMainMenuScene(){this.loading>100&&this.main.toMainMenuScene(),this.loading=100}control(t){this.goToMainMenuScene()}click(t){this.goToMainMenuScene()}keydown(t){this.goToMainMenuScene()}keyup(t){this.goToMainMenuScene()}}class U{constructor(t,e=300,i=!0,s=!0,r=3){this.notes=t,this.tempo=e,this.loop=r,this.pitch=s,this.playing=!1,this.audioContext=new AudioContext,this.originalNotes=this.notes,i&&this.start()}getPossibleNotes(){return["A","B","C","D","E"]}getPossibleNotesPitch(){return[1,2,3,4,5,6,7]}toggle(){this.playing?this.stop():this.start()}start(){this.playing=!0,this.playNextNote()}stop(){this.playing=!1}reset(){this.notes=this.originalNotes}getNoteFrequencyByLetter(t){switch(t){case"A":return 440;case"B":return 493.88;case"C":return 261.63;case"D":return 293.66;case"E":return 329.63;case"F":return 349.23;case"G":return 392}return 440}getFrequency(t){var e=this.getNoteFrequencyByLetter(t[0]);return t.length>1?e*Math.pow(2,t[1]/12):e}playNextNote(){if(!this.playing)return;if(0===this.notes.length&&this.loop>0&&(this.notes=this.originalNotes,this.loop--),0===this.notes.length)return this.stop();const t=this.notes[0];let e=1;this.pitch?(this.notes[1],this.notes=this.notes.slice(2)):this.notes=this.notes.slice(1);const i=this.audioContext.createOscillator(),s=this.audioContext.createGain();i.connect(s),s.connect(this.audioContext.destination),i.frequency.setValueAtTime(this.getFrequency(t),this.audioContext.currentTime),i.start(),s.gain.setValueAtTime(0,this.audioContext.currentTime),s.gain.exponentialRampToValueAtTime(.05,this.audioContext.currentTime+.02),setTimeout((()=>{s.gain.setValueAtTime(.05,this.audioContext.currentTime),s.gain.exponentialRampToValueAtTime(.001,this.audioContext.currentTime+.02),i.stop(this.audioContext.currentTime+.02),this.playNextNote()}),60/this.tempo*1e3)}}class $ extends e{constructor(t){super(t),this.sprites={steel:_.steel,water:_.water,snow:_.snow,grass:_.grass,dirt:_.dirt,magic:_.magic,player:_.player},this.textx=this.main.config.width<400?32:100,this.cursorLocations=[{x:this.textx,y:128},{x:this.textx,y:160},{x:this.textx,y:192},{x:this.textx,y:224},{x:this.textx,y:256},{x:this.textx,y:288},{x:this.textx,y:320}],this.playername="robin hood",this.currentcursorloc=0,this.sound=!1,this.cheatmode=!1,this.buffer=this.staticBuffer()}staticBuffer(){var t=h(this.main.config.width,this.main.config.height);return n(t),t}update(t){this.time=t}draw(t){let e=20;t.clearRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="black",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="green",t.font="16px Arial",t.drawImage(this.buffer,0,0);var i="Verdana",s="green";t.drawImage(R.get("█ ⓅⓁⒶⓎ ⒼⒶⓂⒺ",24,s,this.sprites.grass,i),this.cursorLocations[0].x+20,this.cursorLocations[0].y),t.drawImage(R.get("█ SOUND : "+(this.sound&&1==this.sound?"on":"off"),24,s,this.sprites.water,i),this.cursorLocations[1].x+20,this.cursorLocations[1].y),t.drawImage(R.get("█ Music : "+(this.musicPlayer&&this.musicPlayer.playing?"on":"off"),24,s,this.sprites.water,i),this.cursorLocations[2].x+20,this.cursorLocations[2].y),t.drawImage(R.get(`█ NAME : ${this.playername}`,24,s,this.sprites.water,i),this.cursorLocations[3].x+20,this.cursorLocations[3].y),t.drawImage(R.get("█ Cheatmode : "+(this.cheatmode?"on":"off"),24,s,this.sprites.snow,i),this.cursorLocations[4].x+20,this.cursorLocations[4].y),t.drawImage(R.get("█ STATS ㋡",24,s,this.sprites.dirt,i),this.cursorLocations[5].x+20,this.cursorLocations[5].y),t.drawImage(R.get("█ GOD MODE : "+(this.godmode?"on":"off"),24,s,this.sprites.snow,i),this.cursorLocations[6].x+20,this.cursorLocations[6].y),t.drawImage(this.sprites.player,this.cursorLocations[this.currentcursorloc].x,this.cursorLocations[this.currentcursorloc].y+4),t.fillText("Time "+this.time,20,e),e+=20}click(t){}control(t){if("s"===t||"ArrowDown"===t)this.currentcursorloc=r(this.currentcursorloc+1)%this.cursorLocations.length;else if("w"===t||"ArrowUp"===t)0==this.currentcursorloc?this.currentcursorloc=this.cursorLocations.length-1:this.currentcursorloc=r(this.currentcursorloc-1)%this.cursorLocations.length;else if("a"===t||"ArrowLeft"===t||"d"===t||"ArrowRight"===t||"space"===t||" "===t)if(0==this.currentcursorloc)(this.main.gamescene||confirm("start new game?"))&&this.main.toGameScene();else if(1==this.currentcursorloc)this.sound?this.sound=!1:this.sound=!0;else if(2==this.currentcursorloc)this.musicPlayer||(this.musicPlayer=new U("E4E4D4E4E4D4E4G4G4A4A4E4E4D4E4E4D4E4G4G4A4A4G4G4E4E4D4E4E4D4E4A4A4",120,!1,!0,2e3)),this.musicPlayer.toggle();else if(3==this.currentcursorloc){var e=prompt("name",this.playername);this.playername=e&&e.length>0?e.substring(0,10):this.playername}else 4==this.currentcursorloc?(this.cheatmode=!0,this.main.gamescene&&(this.main.gamescene.player.cash=1e7)):5==this.currentcursorloc?(this.musicPlayer&&this.musicPlayer.stop(),this.main.gamescene?this.main.toSceneStats():alert("start game before using this page")):6==this.currentcursorloc&&(this.godmode=!0,this.main.gamescene&&this.main.gamescene.player.enableGodMode())}keydown(t){}keyup(t){this.control(t.key)}loadingNewGameScene(){}}class q extends z{constructor(t,e=null){super(t,5,e),this.timesDealtWith=0,this.personalDifficulity=a(2,5)}interact(){this.giveQuest()}giveQuest(){var t=a(0,this.timesDealtWith),e=a(t+this.scene.difficulity,t+this.scene.difficulity+this.personalDifficulity),i=a(t+this.scene.difficulity,t+this.scene.difficulity+this.personalDifficulity),s=(this.personalDifficulity+this.scene.difficulity)*this.scene.player.attributes.LUCK;confirm(`Quest\n ${e} apples and ${i} oranges for ${s} points`)&&(this.scene.player.oranges>=i&&this.scene.player.apples>=e?(this.scene.player.oranges-=i,this.scene.player.apples-=e,this.scene.player.points+=s,this.timesDealtWith++):alert("insufficient materials"))}update(t){}draw(t){t.drawImage(this.sprite,this.center.x,this.center.y)}}class F extends z{constructor(t,e=null){super(t,5,e),this.sprite=this.getSprite(),this.timesDealtWith=0,this.personalDifficulity=1}getSprite(){return u(O.npcman,this.scene.scalemultiplier,(t=>"#bf0a0a"==t||"#990000"==t?"#76428a":t))}interact(){this.giveTrade()}giveTrade(){var t=this.scene.difficulity,e=this.timesDealtWith+this.scene.difficulity,i=a(t,e),s=a(t,e),r=this.scene.difficulity*(i+s);(r-=a(0,this.scene.player.attributes.LUCK*r/2))<=0&&(r=1),confirm(`trade offer\n${i} apples and ${s} oranges for ${r} $`)&&(this.scene.player.cash>=r?(this.scene.player.oranges+=s,this.scene.player.apples+=i,this.scene.player.cash-=r,this.timesDealtWith++):alert("not enough cash"))}update(t){}draw(t){t.drawImage(this.sprite,this.center.x,this.center.y)}}class V extends z{constructor(t,e=null){super(t,5,e),this.sprite=this.getSprite()}getSprite(){var t=u(O.wizzard,this.scene.scalemultiplier,(t=>t));return A(t,this.scene.tileSize,this.scene.tileSize)}interact(){this.giveTrade()}giveTrade(){confirm("magic bow 1000000 $")&&(this.scene.player.cash>=1e6?alert("you have your skills, you dont need a magic bow"):alert("insufficient cash"))}update(t){}draw(t){t.drawImage(this.sprite,this.center.x,this.center.y)}}class W{constructor(t,e=2){this.scene=t,this.mult=e,this.mobs=[],this.sprite=u(O.cave,e)}setHeadPoint(t){var e=this.sprite.width,i=this.sprite.height;this.center=new H(t.x+e/2,t.y+i/2);var s=new H(t.x+this.scene.tileSize,t.y+i);this.spawnLocations=[s]}draw(t){t.drawImage(this.sprite,this.center.x-this.sprite.width/2,this.center.y-this.sprite.height/2)}update(t){if(this.mobs=this.mobs.filter((t=>t.life>0)),[...this.mobs].forEach((e=>{e.update&&e.update(t)})),this.time!=t&&(this.time=t,this.center.distanceTo(this.scene.player.center)<=4.5*this.scene.tileSize))for(let t in this.spawnLocations)if(!(e=this.scene.haveEntityAt(this.spawnLocations[t].x,this.spawnLocations[t].y))){var e=new z(this.scene,3,this.spawnLocations[t]);this.mobs.push(e),this.scene.mobs.push(e)}}}const K=[{n:"p",o:1,c:"#0d3702"},{n:"p",o:1,c:"#bf0a0a"},{n:"p",o:0,c:"#d9a066"},{n:"p",o:0,c:"#99e550"},{n:"p",o:2,c:"#8a99f6"},{n:"p",o:1,c:"#6a6a6a"},{n:"p",o:0,c:"#dcdcdc"},{n:"p",o:0,c:"#130c40"},{n:"p",o:1,c:"#fff300"},{n:"p",o:1,c:"#76428a"},{n:"p",o:1,c:"#191919"},{n:"p",o:0,c:"#ff0000"},{n:"p",o:1,c:"#2e2b2b"},{n:"p",o:0,c:"#df7126"},{n:"p",o:0,c:"#d1d1d1"},{n:"p",o:0,c:"#898898"}],Y=t=>{switch(t){case"#130c40":return"player";case"#fff300":return"villager";case"#76428a":return"merchant";case"#191919":return"wizzard";case"#a9a9a9":return"castle";case"#2e2b2b":return"cave"}return null};class j{constructor(t,e=1){this.gamescene=t,this.sprites_dirt=I(_.dirt,4),this.sprites_grass=I(_.grass,4),this.sprites_water=I(_.water,4),this.sprites_snow=I(_.snow,4),this.sprites_brick=I(_.brick,4),this.sprites_steel=I(_.steel,4),this.sprites_tree=u(O.tree,4),this.sprites_house=u(O.house,4),this.sprites_shop=u(O.shop,4),this.PLAYERLOCATION=[0,0],this.VILLAGERS=[],this.BUILDINGS=[],this.colorMatrix=[],this.tileMatrix=[],this.caves=[],this.deerspawnpoints=[],this.getPredefinedMap1(e),this.pathMatrix=this.getPathfindMatrix()}getPathfindMatrix(){var t={};for(let e in K)t[K[e].c]=K[e].o;for(var e=[],i=0;i<this.colorMatrix.length;i++){e[i]=[];for(var s=0;s<this.colorMatrix[i].length;s++){var r=t[this.colorMatrix[s][i]],a=null!=r&&0==r;e[i][s]=a?0:1}}return e}getColorAt(t,e){return t=Math.floor(t),e=Math.floor(e),t<0||t>this.colorMatrix.length-1||e<0||e>this.colorMatrix.length-1?null:this.colorMatrix[e][t]}isObstacleAt(t,e){if(t=Math.floor(t),e=Math.floor(e),t<0)return!0;if(t>this.colorMatrix.length-1)return!0;if(e<0)return!0;if(e>this.colorMatrix.length-1)return!0;if(!this.colorMatrix[t])return!0;var i=this.colorMatrix[e][t];return this.isObstacle(i)}isObstacle(t){var e=K.find((e=>e.c==t));return null==e?1:e.o}getMapPixels(){var t=_.map_spawn,e=_.map_castle,i=_.map_forest_1,s=_.map_forest_2,r=_.map_forest_3,a=_.map_forest_4,o=t.width,c=t.height,l=h(3*o,3*c),u=n(l);for(let t=0;t<3;t++)for(let e=0;e<3;e++)u.drawImage(i,t*o,e*o);return u.drawImage(s,o,0),u.drawImage(r,2*o,2*o),u.drawImage(a,2*o,o),u.drawImage(e,0,0),u.drawImage(t,o,o),l}getMapItems(t,e=32){var i=[],s=[],r={},a=t.length,h=t[0].length;i=new Array(a).fill(null).map((()=>new Array(h).fill(null))),s=new Array(a).fill(null).map((()=>new Array(h).fill(null)));var n=new H(32,32),o=[],c=[];C(t,((t,a,h)=>{if(i[a][h]=(t=>{switch(t){case"#99e550":return"grass";case"#d9a066":return"dirt";case"#dcdcdc":return"snow";case"#8a99f6":return"water"}return null})(t)||"grass",s[a][h]=(t=>{switch(t){case"#0d3702":return"tree";case"#bf0a0a":return"brick";case"#6a6a6a":return"steel";case"#fbf236":return"house";case"#eca732":return"shop"}return null})(t)||null,r[Y(t)]||(r[Y(t)]=[]),Y(t))if(r[Y(t)].push([a,h]),"player"==Y(t))n=new H(a*e,h*e);else if("villager"==Y(t))o.push(new q(this.gamescene,new H(a*e,h*e)));else if("merchant"==Y(t))o.push(new F(this.gamescene,new H(a*e,h*e)));else if("wizzard"==Y(t))o.push(new V(this.gamescene,new H(a*e,h*e)));else if("castle"==Y(t)){var l=new G(this.gamescene,4);l.setHeadPoint({x:a*e,y:h*e}),c.push(l)}else if("cave"==Y(t)){var u=new W(this.gamescene,4);u.setHeadPoint({x:a*e,y:h*e}),c.push(u)}}));var l=this.buildCanvasForMap(i,e),u=this.buildCanvasForMap(s,e);return{tilemap:i,objectsmap:s,tilemapcanvas:l,objectsmapcanvas:u,entitymap:r,playerLocation:n,villagers:o,buildings:c}}buildCanvasForMap(t,e=32){var i=h(t.length*e,t.length*e),s=n(i);return C(t,((t,i,r)=>{var a=t?this.getImageSprite(t):null;t&&a&&s.drawImage(a,r*e,i*e)})),i}getImageSprite(t){switch(t){case"dirt":return this.sprites_dirt;case"grass":return this.sprites_grass;case"water":return this.sprites_water;case"snow":return this.sprites_snow;case"brick":return this.sprites_brick;case"steel":return this.sprites_steel;case"tree":return this.sprites_tree;case"house":return this.sprites_house;case"shop":return this.sprites_shop;default:return null}}getPredefinedMap1(t=1){var e=this.getMapPixels();this.map=e;var i=16*t,s=p(e);this.colorMatrix=s;var r=this.getMapItems(s,i);this.mapItems=r,this.PLAYERLOCATION=this.mapItems.playerLocation,this.VILLAGERS=this.mapItems.villagers,this.BUILDINGS=this.mapItems.buildings;var a=M([r.tilemapcanvas,r.objectsmapcanvas]);this.mapcanvas=a}}class Q{constructor(t,e,i,s,r){this.game=t,this.center=new H(0,0),this.h=i,this.w=e,this.ox=s,this.oy=r}fixToCords(t){this.center=new H(t.x,t.y)}mapToPoint(t){this.center=t}move(t){this.center.move(t,32)}getCanvas(t){var e={x:this.center.x-this.w/2,y:this.center.y-this.h/2};return l(t,e.x<0?0:e.x,e.y<0?0:e.y,this.w,this.h)}draw(t,e){let i,s,r,a,h,n,o,c,l=e;i=s=r=a=h=n=o=c=0;let u={x:this.center.x-this.w/2,y:this.center.y-this.h/2};i=u.x,s=u.y,i<=0&&(i=0,this.center.x=i+this.w/2),s<=0&&(s=0,this.center.y=s+this.h/2),i+this.w>l.width&&(i=l.width-this.w,this.center.x=i+this.w/2),s+this.h>l.height&&(s=l.height-this.h,this.center.y=s+this.h/2),h=this.ox,n=this.oy,r=o=this.w,a=c=this.h,t.drawImage(l,i,s,r,a,h,n,o,c)}getFxy(t,e,i=32){var s={x:this.center.x-this.w/2,y:this.center.y-this.h/2},r=s.y<0?0:s.y;let a=t+(s.x<0?0:s.x)-this.ox,h=e+r-this.oy;return a=Math.floor(a/i)*i,h=Math.floor(h/i)*i,new H(a,h)}}class X{constructor(t){this.ARCHERY=6,this.HEALTH=1,this.POWER=1,this.SPEED=10,this.STELTH=1,this.LUCK=1}enableGodMode(){this.ARCHERY=15,this.HEALTH=15,this.POWER=15,this.SPEED=15,this.STELTH=15,this.LUCK=15}static clone(t){var e=new X;e.ARCHERY=t.ARCHERY,e.HEALTH=t.HEALTH,e.POWER=t.POWER,e.SPEED=t.SPEED,e.STELTH=t.STELTH,e.LUCK=t.LUCK}getAttrByName(t){switch(t){case"ARCHERY":return this.ARCHERY;case"HEALTH":return this.HEALTH;case"POWER":return this.POWER;case"SPEED":return this.SPEED;case"STELTH":return this.STELTH;case"LUCK":return this.LUCK;default:return 0}}editAttrByName(t,e){switch(t){case"ARCHERY":return this.ARCHERY=e,!0;case"HEALTH":return this.HEALTH=e,!0;case"POWER":return this.POWER=e,!0;case"SPEED":return this.SPEED=e,!0;case"STELTH":return this.STELTH=e,!0;case"LUCK":return this.LUCK=e,!0;default:return!1}}getStatMenu(){return[{n:"HEALTH",v:this.HEALTH},{n:"POWER",v:this.POWER},{n:"ARCHERY",v:this.ARCHERY},{n:"SPEED",v:this.SPEED},{n:"STELTH",v:this.STELTH},{n:"LUCK",v:this.LUCK}]}}class J{constructor(t){this.center=new H(t.x,t.y),this.life=1}draw(t){t.drawImage(this.sprite,this.center.x,this.center.y)}}class Z extends J{constructor(t){super(t.center),this.e=t,this.direction=t.direction,this.sprites=this.getSprites(),this.sprite=this.sprites[this.direction],this.width=this.sprite.width,this.height=this.sprite.height,this.speed=this.width,this.distanceToTravel=this.e.attributes.ARCHERY,this.movement=0,this.life=1}update(t){this.time=t,this.movement++,this.movement<this.distanceToTravel?(this.center.move(this.direction,this.speed),this.e.applyArrowEffect(this)):this.life=0}getSprites(){if(Z.SPRITES)return Z.SPRITES;var t=this.e.scene.scalemultiplier,e=16*t,i=A(u(O.arrow,t),e,e),s=c(i,0),r=c(i,2),a=c(i,4),h=c(i,6);this.w=s.width,this.h=s.height;var n=[h,h,s,s,r,r,a,h];return Z.SPRITES=n,Z.SPRITES}}class tt extends J{constructor(t,e,i=1,s=0){super(e),this.scene=t,this.value=i,this.sprite=this.getCoinSprite()}update(t){this.time=t,this.center.distanceTo(this.scene.player.center)<1.5*this.scene.tileSize&&(this.scene.player.cash+=this.value,this.life=0)}draw(t){super.draw(t)}getCoinSprite(){if(tt.CoinSprite)return tt.CoinSprite;var t=this.scene.scalemultiplier,e=this.scene.tileSize,i=A(u(O.coin,t),e,e,!1);return tt.CoinSprite=i,i}}class et{constructor(t){this.scene=t,this.life=this.maxLife=100,this.score=0,this.cash=0,this.points=0,this.apples=0,this.oranges=0,this.attributes=new X(1),this.center=new H(0,0),this.destination=new H(0,0),this.isMoving=!1,this.time=0,this.direction=v,this.sprites=this.getSprites(),this.sprite=this.sprites[v],this.firecooldown=0,this.shots=[],this.hunts=[],this.ArrowsCount=1e3}enableGodMode(){this.cash=1e7,this.points=1e7,this.apples=1e7,this.oranges=1e7,this.ArrowsCount=1e7,this.life=1e7,this.attributes.enableGodMode()}getRadius(){var t=this.scene.tileSize*(12-this.attributes.STELTH);return t<=1.5*this.scene.tileSize&&(t=1.5*this.scene.tileSize),t}setPosition(t){this.center=new H(t.x,t.y),this.destination=new H(t.x,t.y)}update(t){this.firecooldown=Math.max(this.firecooldown-1,0),this.shots=this.shots.filter((t=>t.life>0)),[...this.shots].forEach((e=>{e.update&&e.update(t)})),this.time=t,0!=this.center.distanceTo(this.destination)?(this.isMoving=!0,this.center.movetoward(this.destination,this.sprite.width/2),this.scene.camera.fixToCords(this.center)):this.isMoving=!1,this.mobs=this.scene.mobs.filter((t=>t.center.distanceTo(this.center)<this.getRadius())),this.mobs.length>0&&[...this.mobs].forEach((t=>{t.update&&t.update(this.time)}))}fire(){this.firecooldown>0||(this.firecooldown=20-2*this.attributes.ARCHERY,this.ArrowsCount--,this.shots.push(new Z(this)),this.playSwooshSound())}fireMagicArrow(){this.firecooldown>0||(this.firecooldown=20-2*this.attributes.ARCHERY,this.ArrowsCount--,this.shots.push(new Z(this)),this.playSwooshSound())}damageEffect(){this.showDamageEffect=10}useSword(){this.usingsword=10}applyArrowEffect(t){var e=t.center,i=this.scene.gamemap.isObstacleAt(e.x/this.scene.tileSize,e.y/this.scene.tileSize);1!=i&&1!=i||2==i||(t.life=0,this.playArrowHitSound());for(let e=0;e<this.scene.mobs.length;e++){var s=this.scene.mobs[e];if(s.center.distanceTo(t.center)<this.scene.tileSize){if(null==s.type)continue;s.life-=t.life,s.life<=0&&(this.scene.mobs.push(new tt(this.scene,s.center,s.type+1)),5==s.type?this.score-=s.type+1:this.score+=s.type+1),this.playArrowHitSound(),t.life=0}}}getHealthBar(){var t=h(this.sprite.width,3),e=n(t);e.fillStyle="green",this.life<this.maxLife/2&&(e.fillStyle="orange"),this.life<this.maxLife/2&&(e.fillStyle="red");var i=this.sprite.width*(this.life/this.maxLife);return e.fillRect(0,0,i,3),t}draw(t){t.drawImage(this.sprite,this.center.x,this.center.y),this.direction==v?t.drawImage(this.bow,this.center.x+this.sprite.width-this.bow.width,this.center.y+this.sprite.height-1.5*this.bow.height):this.direction==S?t.drawImage(T(this.bow),this.center.x+this.sprite.width-1.6*this.bow.width,this.center.y+this.sprite.height-1.3*this.bow.height):this.direction==w&&t.drawImage(this.bow,this.center.x+this.sprite.width-1.2*this.bow.width,this.center.y+this.sprite.height-1.3*this.bow.height),[...this.shots].forEach((e=>{e.draw&&e.draw(t)})),t.drawImage(this.getHealthBar(),this.center.x,this.center.y),this.showDamageEffect>0&&(t.fillStyle="#ff0000aa",t.fillRect(this.center.x,this.center.y,this.sprite.width,this.sprite.height),this.showDamageEffect--),this.drawRadius(t)}rotateToward(t,e){var i=this.center.getDirectionTo(new H(t,e));this.direction=i,this.sprite=this.sprites[i]}moveTo(t,e){if(!this.scene.checkObstacle(t,e)){var i=this.center.getDirectionTo(new H(t,e));this.direction=i,0!=this.center.distanceTo(new H(t,e))&&(this.sprite=this.sprites[i],this.move(i))}}move(t){t===this.direction?this.isMoving||this.destination.move(t,this.width):this.direction=t}getSprites(){this.bow=u(O.bow,this.scene.scalemultiplier);var t=u(O.player,this.scene.scalemultiplier),e=u(O.playerb,this.scene.scalemultiplier),i=u(O.players,this.scene.scalemultiplier);return this.width=t.width,this.height=t.height,[e,e,i=A(i,this.width,this.height),t,t,t,T(i,!0),e]}getSprite(){return this.sprite}playSwooshSound(){if(this.scene.main.mainmenuscene.sound){for(var t=function(t){if(t>2e4)return null;var i=e(t,2e4);return 93&Math.pow(50*t,.7)?i:-i},e=(t,e)=>(e-t)/e,i=new AudioContext,s=i.createBuffer(1,96e3,48e3),r=s.getChannelData(0),a=96e3;a--;)r[a]=t(a);var h=i.createBufferSource();h.buffer=s,h.connect(i.destination),h.start()}}playArrowHitSound(){}drawRadius(t){var e=this.getRadius();e<=0||(t.beginPath(),t.arc(this.center.x+this.sprite.width/2,this.center.y+this.sprite.width/2,e,0,2*Math.PI,!1),t.setLineDash([5,25]),t.strokeStyle="red",t.stroke(),t.setLineDash([]))}}class it{constructor(t){this.maze=t,this.rows=t.length,this.cols=t[0].length}findPath(t,e,i,s){t=Math.floor(t),e=Math.floor(e),i=Math.floor(i),s=Math.floor(s);const r=[],a=new Set,h={},n=new Array(this.rows).fill(null).map((()=>new Array(this.cols).fill(1/0)));n[t][e]=0;const o=new Array(this.rows).fill(null).map((()=>new Array(this.cols).fill(1/0)));for(o[t][e]=this.heuristic(t,e,i,s),r.push([t,e]);r.length>0;){const t=this.findLowestFScore(r,o),[e,c]=t;if(e===i&&c===s)return this.reconstructPath(h,t);r.splice(r.indexOf(t),1),a.add(`${e}-${c}`);const l=this.getNeighbors(e,c);for(const u of l){const[l,p]=u;if(a.has(`${l}-${p}`)||this.maze[l][p])continue;const d=n[e][c]+1;d<n[l][p]&&(h[`${l}-${p}`]=t,n[l][p]=d,o[l][p]=d+this.heuristic(l,p,i,s),r.includes(u)||r.push(u))}}return null}heuristic(t,e,i,s){return Math.abs(t-i)+Math.abs(e-s)}findLowestFScore(t,e){let i=t[0],s=e[i[0]][i[1]];for(const r of t){const[t,a]=r;e[t][a]<s&&(i=r,s=e[t][a])}return i}getNeighbors(t,e){const i=[];return t>0&&i.push([t-1,e]),t<this.rows-1&&i.push([t+1,e]),e>0&&i.push([t,e-1]),e<this.cols-1&&i.push([t,e+1]),i}reconstructPath(t,e){const i=[e];for(;t.hasOwnProperty(`${e[0]}-${e[1]}`);)e=t[`${e[0]}-${e[1]}`],i.unshift(e);return i}}class st extends e{constructor(t){super(t),this.init()}init(){this.difficulity=1,this.MOBCOUNT=5,this.scalemultiplier=2,this.tileSize=16*this.scalemultiplier,this.keyboard={},this.gamemap=new j(this,this.scalemultiplier),this.miniMap=L(this.gamemap.map,.7),this.player=new et(this),this.main.mainmenuscene.cheatmode&&(this.player.cash=1e7),this.main.mainmenuscene.godmode&&this.player.enableGodMode(),this.player.setPosition(this.gamemap.PLAYERLOCATION?this.gamemap.PLAYERLOCATION:new H(224,224)),this.camera=new Q(this,this.main.config.width,this.main.config.height,0,0),this.camera.mapToPoint(this.player.center),this.playername="robin hood",this.VILLAGERS=[...this.gamemap.VILLAGERS],this.BUILDINGS=[...this.gamemap.BUILDINGS],this.mobs=[],this.drops=[],this.pathMatrix=this.gamemap.pathMatrix,this.pathFinder=new it(this.pathMatrix),this.validSpawnPointsForMobs=this.findValidSpawnPointInMap(),this.spawnPointsTest=this.findAllValidSpawnPoint(),this._spawnMobs()}haveEntityAt(t,e){t=Math.floor(t),e=Math.floor(e);var i=new H(t,e);for(let t=0;t<this.VILLAGERS.length;t++)if((s=this.VILLAGERS[t]).center.distanceTo(i)<this.tileSize)return s;for(let t=0;t<this.mobs.length;t++){var s;if((s=this.mobs[t]).center.distanceTo(i)<this.tileSize)return s}return null}checkObstacle(t,e){return null!=this.haveEntityAt(t,e)||this.gamemap.isObstacleAt(t/this.tileSize,e/this.tileSize)}getBuffer(){var t=h(this.main.config.width,this.main.config.height);let e=n(t);e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle="black",e.fillRect(0,0,e.canvas.width,e.canvas.height);var i=(t=>{if(!t)return null;let e=h(t.width,t.height);return n(e).drawImage(t,0,0),e})(this.gamemap.mapcanvas),s=n(i);if([...this.mobs].forEach((t=>{t.draw&&t.draw(s)})),[...this.VILLAGERS].forEach((t=>{t.draw&&t.draw(s)})),[...this.BUILDINGS].forEach((t=>{t.draw&&t.draw(s)})),this.player.draw(s),this.pathToGo)for(let t in this.pathToGo)e.drawImage(L(this.player.sprite,.8),this.pathToGo[t][0]*this.tileSize,this.pathToGo[t][1]*this.tileSize);var r=this.camera.getCanvas(i);return e.drawImage(r,0,0),t}update(t){this.time=t,this.mobs=this.mobs.filter((t=>t.life>0)),this.player.update(t);for(let t in this.keyboard)this.keyboard[t]&&this.applyKeyboardKey(t);if(this.player.life<=0&&(alert("game over"),this.main.gamescene=null,this.player.life=100,this.main.toMainMenuScene()),this.pathToGo&&this.pathToGo.length>0){var e=this.pathToGo.shift();this.player.center=new H(e[0]*this.tileSize,e[1]*this.tileSize)}this.mobs.length<=0&&(this.MOBCOUNT+=5,this.difficulity++,this._spawnMobs()),[...this.BUILDINGS].forEach((e=>{e.update&&e.update(t)}))}_spawnMobs(){for(let t=0;t<this.MOBCOUNT;t++){if(this.mobs.length>this.MOBCOUNT)return;let t=new z(this,a(0,3));this.mobs.push(t)}}findValidSpawnPointInMap(){var t=[];for(let i=0;i<this.gamemap.colorMatrix.length;i++)for(let s=0;s<this.gamemap.colorMatrix.length;s++){var e=new H(i*this.tileSize,s*this.tileSize);this.gamemap.isObstacleAt(i,s)||t.push(e)}return t}findAValidSpawnPoint(t=8,e=13){var i=this.findAllValidSpawnPoint(t,e);return i.length>0?i[a(0,i.length)]:new H(this.tileSize,this.tileSize)}findAllValidSpawnPoint(t=8,e=13){var i=this.validSpawnPointsForMobs;i=(i=i.filter((e=>e.distanceTo(this.player.center)>this.tileSize*t))).filter((t=>t.distanceTo(this.player.center)<this.tileSize*e));var s=[];for(let t in i){var r=!0;for(let e=0;e<this.mobs.length;e++)if(this.mobs[e].center.distanceTo(new H(i[t].x,i[t].y))<this.tileSize){r=!1;break}r&&s.push(i[t])}return i}interactWithFacingEntity(){var t=this.player.center.moveClone(this.player.direction,this.tileSize),e=this.haveEntityAt(t.x,t.y);e&&e.interact&&e.interact()}applyKeyboardKey(t){if(" "!==t&&"space"!==t||this.player.fire(),"f"===t&&this.player.useSword(),"e"===t)this.interactWithFacingEntity(),this.keyboard={};else if("q"===t)this.keyboard.q=!1,this.main.toMainMenuScene();else if(!this.player.isMoving){var e=this.player.center.clone(),i=!1;if("s"===t||"ArrowDown"===t?(e.move(v,this.player.height),i=!0):"w"===t||"ArrowUp"===t?(e.move(m,this.player.height),i=!0):"d"===t||"ArrowRight"===t?(e.move(w,this.player.height),i=!0):"a"!==t&&"ArrowLeft"!==t||(e.move(S,this.player.height),i=!0),i){var s=this.player.center.getDirectionTo(e);this.player.rotateToward(e.x,e.y),s!=this.player.direction?(this.player.rotateToward(e.x,e.y),this.keyboard={}):this.checkObstacle(e.x,e.y)?this.player.rotateToward(e.x,e.y):this.player.moveTo(e.x,e.y)}}}draw(t){t.clearRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="black",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="green",t.font="16px Arial",t.drawImage(this.getBuffer(),0,0),t.fillStyle="#004b52d6",t.fillRect(0,0,t.canvas.width,48),t.fillStyle="#ffffff",t.fillText("♥ "+k(this.player.life),15,15),t.fillText("⊕ "+k(this.player.score),15,30),t.fillText("☺"+k(this.player.points),15,45),t.fillText("➹\t"+k(this.player.ArrowsCount),96,15),t.fillText("Ֆ\t"+k(this.player.cash),96,30),t.fillText("Mobs "+k(this.mobs.length),192,15),t.fillText("LVL "+k(this.difficulity),192,30),t.drawImage(_.apple,316,4),t.drawImage(_.lemon,316,20),t.fillText("   "+k(this.player.apples),320,15),t.fillText("   "+k(this.player.oranges),320,30),t.drawImage(this.miniMap,0,t.canvas.height-this.miniMap.height),H.drawCircle(t,this.player.center.x/this.tileSize,t.canvas.height-this.miniMap.height+this.player.center.y/this.tileSize,3,"green")}click(t){var e=this.tileSize,i=t.offsetX,s=t.offsetY,r=this.camera.getFxy(i,s,e),a=new H(r.x,r.y);this.pathFinder.findPath(this.player.center.x/e,this.player.center.y/e,a.x/e,a.y/e)}control(t){this.applyKeyboardKey(t)}keydown(t){this.keyboard[t.key]=!0}keyup(t){this.keyboard[t.key]=!1}}class rt{constructor(t){return this.target=t,this.subscribers=[],!!t.addEventListener}sub(t){this.subscribers.push(t)}clear(){this.subscribers=[]}fireEvent(t){var e=this.subscribers;for(var i in e)e[i].notify&&e[i].notify(t)}}class at extends e{constructor(t){super(t),this.sprites={grass:_.grass,player:_.player},this.textx=this.main.config.width<400?32:100,this.gamescene=this.main.gamescene,this.cursorLocations=[],this.attrStatMenu=this.gamescene.player.attributes.getStatMenu();for(let t in this.attrStatMenu)this.cursorLocations.push({x:this.textx,y:192+32*t,k:this.attrStatMenu[t].n});this.currentcursorloc=0,this.buffer=this.getBuffer()}getBuffer(){var t=h(this.main.config.width,this.main.config.height),e=n(t),i=this.cursorLocations[0],s=i.x+20;e.drawImage(this.getText("STATISTICS"),s,i.y-64),e.drawImage(this.getText("POINTS"),s,i.y-32);for(let t in this.cursorLocations){var r=this.cursorLocations[t];e.drawImage(this.getText(`${r.k} `),s,r.y)}return t}update(t){this.time=t}getText(t,e){return R.get(t,24,"white",e||this.sprites.grass)}draw(t){let e=20;t.clearRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="black",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="green",t.font="16px Arial";var i=this.cursorLocations[0],s=i.x+20;t.drawImage(this.buffer,0,0),t.drawImage(this.getText(`${this.gamescene.player.points}`),s+150,i.y-32);for(let e in this.cursorLocations){var r=this.cursorLocations[e];t.drawImage(this.getText(`${this.gamescene.player.attributes.getAttrByName(r.k)}`),s+150,r.y)}t.drawImage(this.sprites.player,this.cursorLocations[this.currentcursorloc].x,this.cursorLocations[this.currentcursorloc].y+4),t.fillText("Time "+this.time,20,e),e+=20}click(t){}control(t){if("q"===t)this.main.toMainMenuScene();else if("w"===t||"ArrowUp"===t)0==this.currentcursorloc?this.currentcursorloc=this.cursorLocations.length-1:this.currentcursorloc=r(this.currentcursorloc-1)%this.cursorLocations.length;else if("s"===t||"ArrowDown"===t)this.currentcursorloc=r(this.currentcursorloc+1)%this.cursorLocations.length;else if("d"==t||"ArrowRight"==t){if(this.gamescene.player.points<=0)return void alert("no points to use");this.currentcursorloc;var e=this.cursorLocations[this.currentcursorloc].k;this.gamescene.player.attributes.getAttrByName(e)>=10?alert("level max reached"):confirm("spend points on upgrading skill "+e)&&(this.gamescene.player.attributes.editAttrByName(e,this.gamescene.player.attributes.getAttrByName(e)+1),this.gamescene.player.points-=1)}}keydown(t){}keyup(t){this.control(t.key)}loadingNewGameScene(){}}class ht{constructor(e){this.config=e,this.container=document.querySelector(e.container),this.canvas=Object.assign(document.createElement("canvas"),{width:e.width,height:e.height,className:"gamecanvas"}),this.container.appendChild(this.canvas),this.eventManager=new rt(document),["keydown","keyup"].forEach((t=>{document.addEventListener(t,(e=>{this.eventManager.fireEvent({name:t,event:e})}))})),this.canvas.addEventListener("click",(t=>{this.eventManager.fireEvent({name:"click",event:t})})),this.toLoadingScene(),this.config.width<400&&(e.framerate=e.framerate/2),this.Timer=new t(e.framerate,this,!0),this.enablePhoneControls()}update(t){if(0==this.Timer.p)if(this.time=t,this.framesPassedTillNow++,this.timeHMS=this.timeInHourFormat(t),this.scene)try{this.scene.update(t),this.scene.draw(n(this.canvas))}catch(t){console.log(t),this.Timer.stop()}else this.Timer.stop()}timeInHourFormat(t){let e=Math.floor(t/60),i=Math.floor(e/60);return e=Math.floor(e%60),`${i<10?"0":""}${i}:${e<10?"0":""}${e}:${(t=Math.floor(t%60))<10?"0":""}${t}`}toLoadingScene(){this.scene=new B(this),this.eventManager.clear(),this.eventManager.sub(this.scene)}toScene(t){this.scene=t,this.eventManager.clear(),this.eventManager.sub(this.scene)}toMainMenuScene(){this.mainmenuscene||(this.mainmenuscene=new $(this)),this.scene=this.mainmenuscene,this.eventManager.clear(),this.eventManager.sub(this.scene)}toGameScene(){this.gamescene||(this.gamescene=new st(this)),this.scene=this.gamescene,this.eventManager.clear(),this.eventManager.sub(this.scene)}toSceneStats(){this.statScene||(this.statScene=new at(this)),this.scene=this.statScene,this.eventManager.clear(),this.eventManager.sub(this.scene)}enablePhoneControls(){if(!(this.config.width>400)){var t=Object.assign(document.createElement("div"),{className:"controls_container"});t.innerHTML="<table>\n        <tr><td id='q'>q</td><td id='w'>w</td><td id='e'>e</td><td class=\"padding\"></td><td id='space'>space</td> </tr>\n        <tr><td id='a'>a</td><td id='s'>s</td><td id='d'>d</td><td class=\"padding\"></td><td id='f'>f</td></tr></table>",this.container.appendChild(t);var e=((t,e=document)=>e.querySelectorAll(t))(".controls_container td");for(let t=0;t<e.length;t++)e[t].addEventListener("click",(i=>{this.eventManager.fireEvent({name:"control",event:{key:e[t].id}})})),e[t].addEventListener("touchstart",(i=>{this.eventManager.fireEvent({name:"controlts",event:{key:e[t].id}})})),e[t].addEventListener("touchend",(i=>{this.eventManager.fireEvent({name:"controlte",event:{key:e[t].id}})}))}}}const nt={container:".canvas_container",tile:32,aspect:1,framerate:1/30,width:32*parseInt(window.innerWidth/32),height:32*parseInt(window.innerHeight/32),assets:"Assets",spritesheet:s("#spriteSheetMain")};class ot extends ht{constructor(t){super(t)}}document.addEventListener("DOMContentLoaded",(function(){window.game||(window.game=new ot(nt))}),!1)})();